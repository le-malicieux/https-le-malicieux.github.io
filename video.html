<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visionnage - Le Malicieux</title>
    <style>
        :root { --primary: #ff4757; --bg: #0f0f0f; --text: #eee; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; }
        .container { max-width: 1100px; margin: 0 auto; }
        .header-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 10px; }
        .back-btn { padding: 10px 18px; background: #222; color: white; text-decoration: none; border-radius: 6px; border: 1px solid #444; }
        .back-btn:hover { background: var(--primary); border-color: var(--primary); }
        .episode-selector { padding: 10px; border-radius: 6px; background: #1a1a1a; color: white; border: 1px solid var(--primary); }
        .video-container { width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 12px; overflow: hidden; border: 1px solid #333; margin-bottom: 20px; }
        iframe { width: 100%; height: 100%; border: none; }
        .details { display: flex; gap: 20px; flex-wrap: wrap; background: #111; padding: 25px; border-radius: 15px; border: 1px solid #222; }
        .details img { width: 220px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .info { flex: 1; min-width: 300px; }
        h1 { color: var(--primary); margin: 0 0 10px 0; font-size: 1.8em; }
        .tag { background: #222; padding: 6px 12px; border-radius: 20px; font-size: 0.85em; margin-right: 8px; border: 1px solid #333; }
        .desc { line-height: 1.6; color: #aaa; margin-top: 20px; white-space: pre-wrap; font-size: 1.05em; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-nav">
            <a href="index.html" class="back-btn">‚Üê Catalogue</a>
            <div id="selector-container"></div>
        </div>
        <div id="video-wrapper" class="video-container">
            <p style="text-align:center; padding-top:20%; color:#666;">Chargement du lecteur...</p>
        </div>
        <div id="details-content"></div>
    </div>

    <script>
        const clean = (str) => (str || "").replace(/^"|"$/g, "").trim();

        function splitCSVLine(line) {
            const result = [];
            let current = "", inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                let char = line[i];
                if (char === '"') inQuotes = !inQuotes;
                else if (char === ';' && !inQuotes) { result.push(current); current = ""; }
                else current += char;
            }
            result.push(current);
            return result;
        }

        function formatSrc(url) {
            if(!url || url.length < 5) return "";
            let u = url.trim();
            if(u.includes('streamtape.com/v/')) u = u.replace('/v/', '/e/');
            return u;
        }

        async function init() {
            const name = new URLSearchParams(window.location.search).get('name');
            try {
                const res = await fetch('animes.csv');
                const rows = (await res.text()).split(/\r?\n(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                
                let a = null;
                for(let i=1; i<rows.length; i++) {
                    let c = splitCSVLine(rows[i]);
                    if (clean(c[0]) === name) {
                        a = { nom: clean(c[0]), score: clean(c[2]), eps: clean(c[4]), desc: clean(c[7]), img: clean(c[8]), 
                             urls: clean(c[9]).split(',').filter(x => x.length > 5) };
                        break;
                    }
                }

                if(a) {
                    if(a.urls.length > 0) {
                        document.getElementById('video-wrapper').innerHTML = `<iframe id="player" src="${formatSrc(a.urls[0])}" allowfullscreen></iframe>`;
                        if(a.urls.length > 1) {
                            let s = `<select class="episode-selector" onchange="document.getElementById('player').src=this.value">`;
                            a.urls.forEach((u, i) => s += `<option value="${formatSrc(u)}">√âpisode ${i+1}</option>`);
                            document.getElementById('selector-container').innerHTML = s + `</select>`;
                        }
                    } else {
                        document.getElementById('video-wrapper').innerHTML = `<p style="text-align:center; padding-top:20%;">Lien vid√©o bient√¥t disponible.</p>`;
                    }
                    document.getElementById('details-content').innerHTML = `
                        <div class="details">
                            <img src="img/${a.img}" onerror="this.src='https://via.placeholder.com/220x310'">
                            <div class="info">
                                <h1>${a.nom}</h1>
                                <div><span class="tag">‚≠ê ${a.score}/10</span><span class="tag">üì∫ ${a.eps} √©pisodes</span></div>
                                <div class="desc">${a.desc}</div>
                            </div>
                        </div>`;
                }
            } catch(e) { console.error(e); }
        }
        init();
    </script>
</body>
</html>
